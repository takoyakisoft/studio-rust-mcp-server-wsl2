name: Upstream Sync

on:
  schedule:
    - cron: "0 0 * * *" # Daily at 0:00 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: linux-wsl2-build
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Add Upstream and Fetch
        run: |
          git remote add upstream https://github.com/Roblox/studio-rust-mcp-server.git
          git fetch upstream

      - name: Merge Upstream Changes
        run: |
          # Prioritize local changes for GitHub Workflow files (ours)
          git checkout linux-wsl2-build .github/workflows/build.yml
          git checkout linux-wsl2-build .github/workflows/checks.yml
          git checkout linux-wsl2-build README.md

          # Attempt merge to incorporate upstream changes for other files
          # If conflicts occur, prioritize our changes (Workflow settings) while incorporating code changes
          # We use a strategy to merge excluding specific files or choosing 'ours' on conflict

          echo "Merging upstream/main into linux-wsl2-build..."

          # Execute merge. Even if conflicts occur, specified files will be overwritten/fixed later
          set +e # Do not stop on error
          git merge upstream/main --no-commit --no-ff
          MERGE_EXIT_CODE=$?
          set -e

          if [ $MERGE_EXIT_CODE -ne 0 ]; then
             echo "Merge conflict detected. resolving..."
             # Resolving conflicts: keep our version of build.yml and checks.yml
             git checkout HEAD -- .github/workflows/build.yml || true
             git checkout HEAD -- .github/workflows/checks.yml || true
             git checkout HEAD -- README.md || true
             
             # Treat other file conflicts as errors (manual intervention required)
             # Conflicts outside of Workflow files are expected to be rare
             # If they occur, auto-commit isn't possible, so we try to add and commit here
             
             git add .github/workflows/build.yml
             git add .github/workflows/checks.yml
             git add README.md
             
             # Check if any other conflicts remain
             if git diff --name-only --diff-filter=U | grep .; then
               echo "Unresolved conflicts in other files."
               exit 1
             fi
             
             git commit -m "Merge upstream/main into linux-wsl2-build (Auto-resolved conflicts)"
          else
             # No conflicts or auto-resolved
             echo "Merge successful (or no conflicts)."
             # Commit if stopped by no-commit
             git commit -m "Merge upstream/main into linux-wsl2-build" || echo "Nothing to commit"
          fi

      - name: Push Changes
        run: git push origin linux-wsl2-build
