name: Upstream Sync

on:
  schedule:
    - cron: "0 0 * * *" # 毎日 UTC 0:00 (日本時間 9:00)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: linux-wsl2-build
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Add Upstream and Fetch
        run: |
          git remote add upstream https://github.com/Roblox/studio-rust-mcp-server.git
          git fetch upstream

      - name: Merge Upstream Changes
        run: |
          # GitHub Workflow関連ファイルは自分の変更を優先する (ours)
          git checkout linux-wsl2-build .github/workflows/build.yml
          git checkout linux-wsl2-build .github/workflows/checks.yml
          git checkout linux-wsl2-build README.md

          # それ以外は本家の変更を取り込むためにマージを試みる
          # コンフリクトが起きた場合は、こちらの変更（Workflowの設定）を優先しつつ、コードの変更は取り込みたい
          # ここでは単純なマージではなく、特定のファイルを除外してマージする戦略をとるか、
          # あるいはコンフリクト時にoursを選択するように設定する

          echo "Merging upstream/main into linux-wsl2-build..."

          # マージ実行。コンフリクトが発生しても、指定ファイルは後で上書きして修正する
          set +e # エラーでも止まらないようにする
          git merge upstream/main --no-commit --no-ff
          MERGE_EXIT_CODE=$?
          set -e

          if [ $MERGE_EXIT_CODE -ne 0 ]; then
             echo "Merge conflict detected. resolving..."
             # コンフリクトしているが、build.ymlとchecks.ymlは自分たちのものを使う
             git checkout HEAD -- .github/workflows/build.yml || true
             git checkout HEAD -- .github/workflows/checks.yml || true
             git checkout HEAD -- README.md || true
             
             # その他のファイルのコンフリクトはそのままエラーにする（手動介入が必要）
             # しかし、Workflowファイル以外でコンフリクトが起きることは稀と想定
             # もし起これば自動コミットできないので、ここではaddしてcommitを試みる
             
             git add .github/workflows/build.yml
             git add .github/workflows/checks.yml
             git add README.md
             
             # 他にコンフリクトが残っていないか確認
             if git diff --name-only --diff-filter=U | grep .; then
               echo "Unresolved conflicts in other files."
               exit 1
             fi
             
             git commit -m "Merge upstream/main into linux-wsl2-build (Auto-resolved conflicts)"
          else
             # コンフリクトなし、または自動解決済み
             echo "Merge successful (or no conflicts)."
             # もしno-commitで止めているならコミットする
             git commit -m "Merge upstream/main into linux-wsl2-build" || echo "Nothing to commit"
          fi

      - name: Push Changes
        run: git push origin linux-wsl2-build
