name: Build

on:
  workflow_dispatch:
  push:
    branches:
      - linux-wsl2-build

env:
  CARGO_PKG_VERSION: "0.2.${{ github.run_number }}"

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history to retrieve version tags

      - name: Get Upstream Version
        run: |
          git remote add upstream https://github.com/Roblox/studio-rust-mcp-server.git
          git fetch upstream --tags
          # Get the latest accessible tag from upstream/main
          VERSION_TAG=$(git describe --tags --abbrev=0 upstream/main 2>/dev/null || echo "v0.0.0")
          # Remove 'v' prefix
          VERSION_NUM=${VERSION_TAG#v}

          echo "Detected upstream version: $VERSION_NUM ($VERSION_TAG)"

          # If the tag cannot be retrieved (v0.0.0), we could fallback to using date or commit hash,
          # but we assume upstream always has a tag.
          # We considered adding +wsl2 to indicate a custom build,
          # but the user requested to match the version number exactly.

          echo "CARGO_PKG_VERSION=$VERSION_NUM" >> $GITHUB_ENV

      - name: Build Linux binary
        run: |
          cargo install cargo-edit
          cargo set-version --workspace "$CARGO_PKG_VERSION"
          mkdir -p output
          cargo build --release
          cp target/release/rbx-studio-mcp rbx-studio-mcp
          zip output/rbx-studio-mcp.zip rbx-studio-mcp
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Linux-rbx-studio-mcp
          path: output/rbx-studio-mcp.zip

  release:
    runs-on: ubuntu-latest
    # Release creation condition: linux-wsl2-build branch
    if: ${{ github.ref_name == 'linux-wsl2-build' }}
    needs: [build-linux]
    steps:
      - run: mkdir -p output
      - uses: actions/download-artifact@v4
        with:
          path: output
          merge-multiple: true
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.CARGO_PKG_VERSION }}
          release_name: Release v${{ env.CARGO_PKG_VERSION }}
          files: output/*
          draft: false
          prerelease: false
