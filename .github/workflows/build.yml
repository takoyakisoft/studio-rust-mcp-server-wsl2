name: Build

on:
  workflow_dispatch:
  push:
    branches:
      - linux-wsl2-build

env:
  CARGO_PKG_VERSION: "0.2.${{ github.run_number }}"

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Linux binary
        run: |
          cargo install cargo-edit
          cargo set-version --workspace "$CARGO_PKG_VERSION"
          mkdir -p output
          cargo build --release
          cp target/release/rbx-studio-mcp rbx-studio-mcp
          zip output/rbx-studio-mcp.zip rbx-studio-mcp
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Linux-rbx-studio-mcp
          path: output/rbx-studio-mcp.zip

  release:
    runs-on: ubuntu-latest
    # リリース作成条件: linux-wsl2-build ブランチ
    if: ${{ github.ref_name == 'linux-wsl2-build' }}
    needs: [build-linux]
    steps:
      - run: mkdir -p output
      - uses: actions/download-artifact@v4
        with:
          path: output
          merge-multiple: true
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.CARGO_PKG_VERSION }}
          release_name: Release v${{ env.CARGO_PKG_VERSION }}
          files: output/*
          draft: false
          prerelease: false
