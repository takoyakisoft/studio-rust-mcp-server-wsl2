name: Build

on:
  workflow_dispatch:
  push:
    branches:
      - linux-wsl2-build

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    outputs:
      version_num: ${{ steps.get_version.outputs.version_num }}
      version_tag: ${{ steps.get_version.outputs.version_tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history to retrieve version tags

      - name: Get Upstream Version
        id: get_version
        run: |
          git remote add upstream https://github.com/Roblox/studio-rust-mcp-server.git
          git fetch upstream --tags
          # Get the latest accessible tag from upstream/main
          VERSION_TAG=$(git describe --tags --abbrev=0 upstream/main 2>/dev/null || echo "v0.0.0")
          # Remove 'v' prefix
          VERSION_NUM=${VERSION_TAG#v}

          echo "Detected upstream version: $VERSION_NUM ($VERSION_TAG)"

          echo "version_num=$VERSION_NUM" >> $GITHUB_OUTPUT
          echo "version_tag=$VERSION_TAG" >> $GITHUB_OUTPUT
          echo "CARGO_PKG_VERSION=$VERSION_NUM" >> $GITHUB_ENV

      - name: Build Linux binary
        run: |
          cargo install cargo-edit
          # Use env var set in previous step
          cargo set-version --workspace "$CARGO_PKG_VERSION"
          mkdir -p output
          cargo build --release
          cp target/release/rbx-studio-mcp rbx-studio-mcp
          zip output/rbx-studio-mcp.zip rbx-studio-mcp
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: Linux-rbx-studio-mcp
          path: output/rbx-studio-mcp.zip

  release:
    runs-on: ubuntu-latest
    # Release creation condition: linux-wsl2-build branch
    if: ${{ github.ref_name == 'linux-wsl2-build' }}
    needs: [build-linux]
    steps:
      - run: mkdir -p output
      - uses: actions/download-artifact@v4
        with:
          path: output
          merge-multiple: true
      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.build-linux.outputs.version_tag }}
          name: Release ${{ needs.build-linux.outputs.version_tag }} (Linux)
          body: |
            This is an automated build for Linux (WSL2) from the [upstream repository](https://github.com/Roblox/studio-rust-mcp-server).

            **Upstream Version:** ${{ needs.build-linux.outputs.version_tag }}
            **Build Branch:** linux-wsl2-build
          files: output/*
          draft: false
          prerelease: false
